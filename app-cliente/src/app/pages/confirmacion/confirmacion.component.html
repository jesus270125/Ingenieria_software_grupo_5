<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/metodo-pago" icon="chevron-back-outline"></ion-back-button>
    </ion-buttons>
    <ion-title>Confirmar Pedido</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Dirección -->
  <ion-card class="info-card">
    <ion-card-header>
      <ion-card-subtitle>Dirección de Entrega</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
        <div class="address-block">
          <label>Dirección de entrega</label>
          <ion-item>
            <ion-icon name="location-outline" slot="start"></ion-icon>
            <ion-input [(ngModel)]="direccion" placeholder="Selecciona tu dirección usando el mapa"></ion-input>
          </ion-item>
          <div class="map-container">
            <div #map id="map"></div>
          </div>
          <ion-button fill="outline" size="small" (click)="initMap()">Usar mi ubicación</ion-button>
        </div>
    </ion-card-content>
  </ion-card>

  <!-- Método de Pago -->
  <ion-card class="info-card">
    <ion-card-header>
      <ion-card-subtitle>Método de Pago</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="row">
        <ion-icon name="card-outline"></ion-icon>
        <p>{{ metodoPago }}</p>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Formulario tarjeta (simulado) -->
  <ion-card *ngIf="metodoPago && metodoPago.toLowerCase().includes('tarjeta')" class="info-card">
    <ion-card-header>
      <ion-card-subtitle>Datos de Tarjeta</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label position="stacked">Número de tarjeta</ion-label>
        <ion-input [(ngModel)]="cardNumber" inputmode="numeric" maxlength="19" placeholder="4242 4242 4242 4242"></ion-input>
      </ion-item>
      <div class="two-cols">
        <ion-item>
          <ion-label position="stacked">Expiración (MM/AA)</ion-label>
          <ion-input [(ngModel)]="cardExpiry" placeholder="MM/AA" maxlength="5"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">CVC</ion-label>
          <ion-input [(ngModel)]="cardCvc" inputmode="numeric" maxlength="4" placeholder="123"></ion-input>
        </ion-item>
      </div>
      <ion-item>
        <ion-checkbox slot="start" [(ngModel)]="saveCard"></ion-checkbox>
        <ion-label>Guardar tarjeta (simulado)</ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <!-- Yape: mostrar sección para generar QR y botón dentro de la página -->
  <ion-card *ngIf="metodoPago && metodoPago.toLowerCase().includes('yape')" class="info-card">
    <ion-card-header>
      <ion-card-subtitle>Pago por Yape</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <div class="center">
        <p>Monto: <b>S/. {{ total | number:'1.2-2' }}</b></p>
        <img [src]="yapeData?.qrUrl || qrPreviewUrl" alt="QR Yape" style="width:220px;height:220px;margin:0 auto;display:block" />
        <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
          <ion-button size="small" color="primary" (click)="openYape()">Dirigir a Yape</ion-button>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Resumen Pedido -->
  <h3 class="section-title">Resumen</h3>
  <div class="order-summary">
    <div class="item-row" *ngFor="let item of items">
      <span>{{ item.quantity }}x {{ item.product.nombre }}</span>
      <span>S/. {{ (item.product.precio * item.quantity) | number:'1.2-2' }}</span>
    </div>

    <div class="divider"></div>

    <!-- Código Promocional -->
    <div class="promo-section">
      <div *ngIf="!promocionAplicada" style="display:flex; gap: 8px; align-items: center;">
        <ion-input 
          [(ngModel)]="codigoPromo" 
          placeholder="Código promocional" 
          style="flex:1; border: 1px solid #ddd; border-radius: 8px; padding: 4px 8px;">
        </ion-input>
        <ion-button 
          size="small" 
          (click)="aplicarCodigo()" 
          [disabled]="validandoCodigo">
          {{ validandoCodigo ? 'Validando...' : 'Aplicar' }}
        </ion-button>
      </div>
      
      <div *ngIf="promocionAplicada" class="promo-aplicada" style="background: #d4edda; padding: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <ion-icon name="checkmark-circle" style="color: #28a745; margin-right: 4px;"></ion-icon>
          <span style="color: #155724; font-weight: 500;">{{ promocionAplicada.codigo }} aplicado</span>
          <p style="font-size: 12px; margin: 2px 0 0 24px; color: #155724;">{{ promocionAplicada.descripcion }}</p>
        </div>
        <ion-button fill="clear" size="small" (click)="quitarCodigo()">
          <ion-icon slot="icon-only" name="close-circle-outline" style="color: #dc3545;"></ion-icon>
        </ion-button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="cost-row">
      <span>Subtotal</span>
      <span>S/. {{ subtotal | number:'1.2-2' }}</span>
    </div>
    <div class="cost-row">
      <span>Envío</span>
      <span>S/. {{ envio | number:'1.2-2' }}</span>
    </div>
    <div class="cost-row" *ngIf="descuento > 0" style="color: #28a745;">
      <span>Descuento</span>
      <span>- S/. {{ descuento | number:'1.2-2' }}</span>
    </div>
    <div class="cost-row total">
      <span>Total a Pagar</span>
      <span>S/. {{ total | number:'1.2-2' }}</span>
    </div>
  </div>

  <ion-button expand="block" shape="round" class="ion-margin-top action-btn" (click)="confirmarPedido()">
    <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
    Confirmar Pedido
  </ion-button>

</ion-content>