<div class="breadcrumb">
    Panel / <strong>Reportes y Métricas</strong>
</div>

<div class="page-header">
    <div class="header-content">
        <div class="header-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
        </div>
        <div class="header-text">
            <h1 class="page-title">Reportes y Métricas</h1>
            <p class="page-subtitle">Analiza el rendimiento del negocio con reportes detallados</p>
        </div>
    </div>
</div>

<!-- Selector de Fechas -->
<div class="card filters-card">
    <div class="filters-header">
        <div class="filters-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            <h3>Seleccionar Periodo</h3>
        </div>
        <button class="btn-generate" (click)="generarReportes()" [disabled]="loading">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
            {{ loading ? 'Generando...' : 'Generar Reportes' }}
        </button>
    </div>
    
    <div class="date-range">
        <div class="filter-group">
            <label>Fecha Inicio</label>
            <input type="date" [(ngModel)]="fechaInicio" class="form-input">
        </div>
        <div class="filter-group">
            <label>Fecha Fin</label>
            <input type="date" [(ngModel)]="fechaFin" class="form-input">
        </div>
    </div>
</div>

<!-- Loader -->
<div *ngIf="loading" class="loader-container">
    <div class="loader"></div>
</div>

<!-- Resumen General -->
<div *ngIf="!loading && resumen" class="stats-row">
    <div class="stat-card stat-pedidos">
        <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
            </svg>
        </div>
        <div class="stat-info">
            <div class="stat-label">Total Pedidos</div>
            <div class="stat-value">{{ resumen.total_pedidos }}</div>
        </div>
    </div>
    <div class="stat-card stat-entregados">
        <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div class="stat-info">
            <div class="stat-label">Entregados</div>
            <div class="stat-value">{{ resumen.pedidos_entregados }}</div>
        </div>
    </div>
    <div class="stat-card stat-ventas">
        <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <div class="stat-info">
            <div class="stat-label">Ventas Totales</div>
            <div class="stat-value">S/. {{ toNumber(resumen.ventas_totales) | number:'1.2-2' }}</div>
        </div>
    </div>
    <div class="stat-card stat-ticket">
        <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 010 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 010-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z" />
            </svg>
        </div>
        <div class="stat-info">
            <div class="stat-label">Ticket Promedio</div>
            <div class="stat-value">S/. {{ toNumber(resumen.ticket_promedio) | number:'1.2-2' }}</div>
        </div>
    </div>
    <div class="stat-card stat-clientes">
        <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
            </svg>
        </div>
        <div class="stat-info">
            <div class="stat-label">Clientes Únicos</div>
            <div class="stat-value">{{ resumen.clientes_unicos }}</div>
        </div>
    </div>
    <div class="stat-card stat-motorizados">
        <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
            </svg>
        </div>
        <div class="stat-info">
            <div class="stat-label">Motorizados Activos</div>
            <div class="stat-value">{{ resumen.motorizados_activos }}</div>
        </div>
    </div>
</div>

<!-- Ventas por Periodo -->
<div class="card" *ngIf="!loading && ventas.length > 0">
    <div class="table-header">
        <div class="table-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
            </svg>
            <h3>Ventas por Día</h3>
        </div>
        <button class="btn-export" (click)="exportarVentasCSV()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Exportar CSV
        </button>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Total Pedidos</th>
                    <th>Entregados</th>
                    <th>Cancelados</th>
                    <th>Ventas</th>
                    <th>Envíos</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let venta of ventas">
                    <td><strong>{{ venta.fecha | date: 'dd/MM/yyyy' }}</strong></td>
                    <td>{{ venta.total_pedidos }}</td>
                    <td class="text-success">{{ venta.pedidos_entregados }}</td>
                    <td class="text-danger">{{ venta.pedidos_cancelados }}</td>
                    <td><strong>S/. {{ toNumber(venta.total_ventas) | number:'1.2-2' }}</strong></td>
                    <td>S/. {{ toNumber(venta.total_envios) | number:'1.2-2' }}</td>
                    <td>S/. {{ toNumber(venta.total_subtotal) | number:'1.2-2' }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Pedidos por Hora -->
<div class="card" *ngIf="!loading && pedidosHora.length > 0">
    <div class="table-header">
        <div class="table-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3>Pedidos por Hora del Día</h3>
        </div>
    </div>

    <div class="chart-container">
        <div class="bar-chart">
            <div class="bar-item" *ngFor="let ph of pedidosHora">
                <div class="bar-wrapper">
                    <div class="bar" [style.height.%]="(ph.cantidad_pedidos / getMaxPedidosHora()) * 100">
                        <span class="bar-value">{{ ph.cantidad_pedidos }}</span>
                    </div>
                </div>
                <div class="bar-label">{{ ph.hora }}:00</div>
            </div>
        </div>
    </div>
</div>

<!-- Rendimiento de Motorizados -->
<div class="card" *ngIf="!loading && motorizados.length > 0">
    <div class="table-header">
        <div class="table-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
            </svg>
            <h3>Rendimiento de Motorizados</h3>
        </div>
        <button class="btn-export" (click)="exportarMotorizadosCSV()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Exportar CSV
        </button>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Motorizado</th>
                    <th>Placa</th>
                    <th>Total Entregas</th>
                    <th>Exitosas</th>
                    <th>Canceladas</th>
                    <th>Total Generado</th>
                    <th>Tasa Éxito</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let m of motorizados">
                    <td><strong>{{ m.motorizado_nombre }}</strong></td>
                    <td>{{ m.placa }}</td>
                    <td>{{ m.total_entregas }}</td>
                    <td class="text-success">{{ m.entregas_exitosas }}</td>
                    <td class="text-danger">{{ m.entregas_canceladas }}</td>
                    <td><strong>S/. {{ toNumber(m.total_generado) | number:'1.2-2' }}</strong></td>
                    <td>
                        <span class="badge" [ngClass]="m.total_entregas > 0 && (m.entregas_exitosas / m.total_entregas * 100) >= 80 ? 'badge-success' : 'badge-warning'">
                            {{ m.total_entregas > 0 ? ((m.entregas_exitosas / m.total_entregas) * 100 | number:'1.0-0') : 0 }}%
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Tiempos de Entrega -->
<div class="card" *ngIf="!loading && tiempos.length > 0">
    <div class="table-header">
        <div class="table-title">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3>Tiempos Promedio de Entrega</h3>
        </div>
        <button class="btn-export" (click)="exportarTiemposCSV()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Exportar CSV
        </button>
    </div>

    <div class="summary-box">
        <div class="summary-item">
            <span class="summary-label">Tiempo Promedio General:</span>
            <span class="summary-value">{{ getPromedioTiempoEntrega() | number:'1.0-0' }} minutos</span>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Pedidos Entregados</th>
                    <th>Tiempo Promedio (minutos)</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let t of tiempos">
                    <td><strong>{{ t.fecha | date: 'dd/MM/yyyy' }}</strong></td>
                    <td>{{ t.pedidos_entregados }}</td>
                    <td>
                        <span class="time-badge">{{ toNumber(t.tiempo_promedio_minutos) | number:'1.0-0' }} min</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Sin datos -->
<div class="card empty-state" *ngIf="!loading && ventas.length === 0 && resumen">
    <p>No hay datos para el periodo seleccionado</p>
</div>
