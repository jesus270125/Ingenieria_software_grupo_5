<div class="evaluaciones-container">
  <div class="header">
    <div class="header-content">
      <div class="header-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
        </svg>
      </div>
      <div class="header-text">
        <h1>Evaluaciones de Servicio</h1>
        <p class="subtitle">Gestión de calificaciones y comentarios de clientes</p>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filtros">
    <div class="filtro-label">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
      </svg>
      Filtrar por calificación
    </div>
    <div class="filtro-buttons">
      <button 
        class="filtro-btn"
        [class.active]="filtroCalificacion === 0" 
        (click)="filtrarPorCalificacion(0)">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
        Todas
      </button>
      <button 
        class="filtro-btn star-btn"
        *ngFor="let i of [5,4,3,2,1]"
        [class.active]="filtroCalificacion === i" 
        (click)="filtrarPorCalificacion(i)">
        <span class="star-count">{{ i }}</span>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading">
    <div class="loading-spinner"></div>
    <p>Cargando evaluaciones...</p>
  </div>

  <!-- Lista de evaluaciones -->
  <div *ngIf="!isLoading" class="evaluaciones-grid">
    <div *ngIf="evaluacionesFiltradas.length === 0" class="no-data">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
      </svg>
      <p>No hay evaluaciones para mostrar</p>
    </div>

    <div *ngFor="let eval of evaluacionesFiltradas" class="evaluacion-card">
      <div class="card-badge" [class]="'badge-' + getClaseCalificacion(eval.calificacion)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
        </svg>
        {{ eval.calificacion }}/5
      </div>

      <div class="card-top">
        <div class="pedido-info">
          <div class="pedido-numero">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
            Pedido #{{ eval.pedido_numero }}
          </div>
          <div class="fecha">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            {{ eval.fecha_evaluacion | date:'dd/MM/yyyy HH:mm' }}
          </div>
        </div>

        <div class="personas-grid">
          <div class="persona-item motorizado">
            <div class="persona-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
              </svg>
            </div>
            <div class="persona-info">
              <span class="persona-label">Motorizado</span>
              <span class="persona-nombre">{{ eval.motorizado_nombre }}</span>
              <span class="persona-extra">{{ eval.motorizado_placa }}</span>
            </div>
          </div>

          <div class="persona-item cliente">
            <div class="persona-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            <div class="persona-info">
              <span class="persona-label">Cliente</span>
              <span class="persona-nombre">{{ eval.cliente_nombre }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card-content">
        <div class="comentario-box" *ngIf="eval.comentario">
          <div class="comentario-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
            </svg>
            Comentario del cliente
          </div>
          <p class="comentario-text">{{ eval.comentario }}</p>
        </div>

        <div class="respuesta-box" *ngIf="eval.respuesta_admin">
          <div class="respuesta-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" />
            </svg>
            Respuesta del administrador
          </div>
          <p class="respuesta-text">{{ eval.respuesta_admin }}</p>
          <div class="respuesta-footer">
            <span class="accion-badge" *ngIf="eval.accion_tomada">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {{ eval.accion_tomada }}
            </span>
            <span class="fecha-respuesta">
              {{ eval.fecha_respuesta | date:'dd/MM/yyyy HH:mm' }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-footer">
        <button class="btn-responder" (click)="abrirModalRespuesta(eval)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 01-.923 1.785A5.969 5.969 0 006 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337z" />
          </svg>
          {{ eval.respuesta_admin ? 'Editar Respuesta' : 'Responder' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Panel lateral de respuesta -->
  <div class="panel-overlay" *ngIf="evaluacionSeleccionada" (click)="cerrarModal()" [@fadeAnimation]>
  </div>

  <div class="side-panel" *ngIf="evaluacionSeleccionada" [@slideAnimation]>
    <div class="panel-header">
      <div class="panel-header-content">
        <div class="panel-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
          </svg>
        </div>
        <div class="panel-title">
          <h2>{{ evaluacionSeleccionada.respuesta_admin ? 'Editar Respuesta' : 'Responder Evaluación' }}</h2>
          <p>Pedido #{{ evaluacionSeleccionada.pedido_numero }}</p>
        </div>
      </div>
      <button class="panel-close" (click)="cerrarModal()">
        ✕
      </button>
    </div>

    <div class="panel-body">
      <!-- Información de la evaluación -->
      <div class="panel-section">
        <div class="section-header">
          <div class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
            </svg>
          </div>
          <h3>Información de la Evaluación</h3>
        </div>
        
        <div class="info-row">
          <span class="info-label">Motorizado</span>
          <span class="info-value">{{ evaluacionSeleccionada.motorizado_nombre }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Placa</span>
          <span class="info-value">{{ evaluacionSeleccionada.motorizado_placa }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Calificación</span>
          <span class="info-value rating-value" [style.color]="getColorCalificacion(evaluacionSeleccionada.calificacion)">
            {{ evaluacionSeleccionada.calificacion }}/5 ★
          </span>
        </div>
        <div class="info-row" *ngIf="evaluacionSeleccionada.comentario">
          <span class="info-label">Comentario</span>
          <span class="info-value">{{ evaluacionSeleccionada.comentario }}</span>
        </div>
      </div>

      <!-- Formulario de respuesta -->
      <div class="panel-section">
        <div class="section-header">
          <div class="section-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
          </div>
          <h3>Respuesta</h3>
        </div>

        <div class="form-group">
          <label>Respuesta del Administrador *</label>
          <textarea 
            [(ngModel)]="respuestaAdmin" 
            rows="5"
            placeholder="Escribe tu respuesta al cliente..."
            class="form-textarea">
          </textarea>
        </div>

        <div class="form-group">
          <label>Acción tomada (opcional)</label>
          <input 
            type="text" 
            [(ngModel)]="accionTomada" 
            placeholder="Ej: Capacitación, Advertencia, etc."
            class="form-input">
        </div>
      </div>
    </div>

    <div class="panel-footer">
      <button class="btn-cancelar" (click)="cerrarModal()" [disabled]="enviandoRespuesta">
        Cancelar
      </button>
      <button class="btn-guardar" (click)="enviarRespuesta()" [disabled]="enviandoRespuesta || !respuestaAdmin.trim()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        {{ enviandoRespuesta ? 'Guardando...' : 'Guardar Respuesta' }}
      </button>
    </div>
  </div>
</div>
